window.currentUser=window.currentUser||{};window.currentChatUserId=null;window.currentConversationId=null;window.messagePoller=null;window.lastMessageId=null;window.blockUser=null;window.unblockUser=null;window.clearChat=null;var O;window.csrfToken=(O=document.querySelector('meta[name="csrf-token"]'))==null?void 0:O.content;const K={conversations:"/api/dashboard/chat/conversations",messages:"/api/dashboard/chat/conversations/:id/messages",send:"/api/dashboard/chat/conversations/:id/messages",sendMessage:"/api/dashboard/chat/conversations/:id/messages",users:"/api/dashboard/chat/users",user:"/api/dashboard/chat/user/:id",unread:"/api/dashboard/chat/unread-counts",block:"/api/dashboard/chat/block/:id",unblock:"/api/dashboard/chat/unblock/:id",blockStatus:"/api/dashboard/chat/block-status/:id",clear:"/api/dashboard/chat/conversations/:id/clear",hide:"/dashboard/chat/hide/:id",publicConversation:"/api/dashboard/chat/conversations/public",public:"/api/dashboard/chat/conversations/public",privateConversation:"/api/dashboard/chat/conversations/private",createPrivate:"/api/dashboard/chat/conversations/private"};window.chatRoutes={...K,...window.chatRoutes||{}};window.contactsState={page:1,perPage:50,hasMore:!0,q:"",loading:!1,onlineOnly:!1};function B(t){try{if(!t)return!1;if(typeof t.is_online<"u")return!!t.is_online;if(typeof t.online<"u")return!!t.online;if(typeof t.status=="string"){const e=t.status.toLowerCase();if(e==="online"||e==="active")return!0}if(t.last_activity){const e=new Date(t.last_activity).getTime();if(!isNaN(e))return Date.now()-e<=5*60*1e3}}catch{}return!1}function z(){try{if(typeof window.isSuperAdmin=="boolean")return!!window.isSuperAdmin;if(Array.isArray(window.currentUserRoles)&&window.currentUserRoles.some(n=>(n||"").toLowerCase()==="super_admin"))return!0;const t=window.currentUser||{};if(typeof t.role=="string")return t.role.toLowerCase()==="super_admin";if(t.role&&typeof t.role.name=="string")return t.role.name.toLowerCase()==="super_admin";if(Array.isArray(t.roles))return t.roles.some(e=>((e==null?void 0:e.name)||"").toLowerCase()==="super_admin");if(t.role_id&&(t.role_id===1||t.role_id==="1"))return!0}catch{}return!1}function W(){const t=document.querySelector(".chat-history-body");t&&(t.scrollTop=t.scrollHeight)}const g={success:"success",danger:"danger",info:"info"},$={success:"ti tabler-check",danger:"ti tabler-ban",warning:"ti tabler-bell",info:"ti tabler-info-circle",primary:"ti tabler-user",secondary:"ti tabler-bookmark",dark:"ti tabler-at"};function p(t,e,n={}){const a=document.getElementById("chat-alerts")||J(),o=document.createElement("div");o.className=`alert alert-solid-${t} d-flex align-items-center alert-dismissible mb-0`;const u=document.createElement("span");u.className="alert-icon rounded";const s=document.createElement("i");s.className=`icon-base ${$[t]||$.success} icon-md`,u.appendChild(s);const r=document.createElement("div");r.className="d-flex flex-column ps-1",r.innerHTML=`
        <h5 class="alert-heading mb-2">${n.title||"تنبيه"}</h5>
        <p class="mb-0">${e}</p>
    `;const h=document.createElement("button");h.type="button",h.className="btn-close",h.setAttribute("data-bs-dismiss","alert"),h.setAttribute("aria-label","Close"),o.appendChild(u),o.appendChild(r),o.appendChild(h),a.appendChild(o),n.timeout!==!1&&setTimeout(()=>{o.remove()},n.timeout||5e3)}function J(){const t=document.createElement("div");return t.id="chat-alerts",t.className="position-fixed top-0 end-0 p-3",t.style.zIndex="2000",document.body.appendChild(t),t}function q(){return localStorage.getItem("chat_sound_enabled")!=="0"}function G(t){localStorage.setItem("chat_sound_enabled",t?"1":"0")}function V(){try{if(!q())return;let t=document.getElementById("chat-sound");t||(t=document.createElement("audio"),t.id="chat-sound",t.src="/sounds/chat.mp3",t.preload="auto",t.style.display="none",document.body.appendChild(t)),t&&typeof t.play=="function"&&t.play().catch(()=>{})}catch{}}function U(){try{if(!("Notification"in window))return;Notification.permission==="default"&&Notification.requestPermission()}catch{}}function Y(t,e){try{if(!("Notification"in window))return;Notification.permission==="granted"&&new Notification(`رسالة من ${(t==null?void 0:t.name)||"مستخدم"}`,{body:(e==null?void 0:e.body)||"",icon:(t==null?void 0:t.avatar)||"/assets/img/avatars/4.png"})}catch{}}function Q(t,e,n){!window.Swal||!window.Swal.fire||window.Swal.fire({toast:!0,position:"bottom-start",icon:"info",title:`رسالة جديدة من ${(t==null?void 0:t.name)||"مستخدم"}`,text:e||"",showConfirmButton:!1,timer:4e3,timerProgressBar:!0,didOpen:a=>{a.addEventListener("click",()=>{typeof E=="function"&&n&&E(n)})}})}function Z(t){const e=document.querySelector(`#chat-badge-${t}`);if(!e)return;const n=parseInt(e.textContent)||0;e.textContent=n+1,e.classList.remove("d-none");const a=document.querySelector(`#chat-bell-${t}`);a&&a.classList.remove("d-none")}function tt(t){const e=document.querySelector(`#chat-badge-${t}`);if(!e)return;e.textContent="0",e.classList.add("d-none");const n=document.querySelector(`#chat-bell-${t}`);n&&n.classList.add("d-none")}function et(t,e){const n=e===window.currentConversationId;if(!n){const a=t.sender||t.user;Z(e),Q(a,t.body,e),Y(a,t),V()}n&&R(t)}(function(){try{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",U):U()}catch{}})();function nt(t,e=300){let n;return(...a)=>{clearTimeout(n),n=setTimeout(()=>t.apply(null,a),e)}}function X(t){try{if(!t)return;const e=document.getElementById("public-chat-li");if(!e)return;let n=document.getElementById(`chat-badge-${t}`),a=document.getElementById(`chat-bell-${t}`);const o=e.querySelector(".flex-grow-1")||e;n||(n=document.createElement("span"),n.id=`chat-badge-${t}`,n.className="badge rounded-pill bg-danger text-uppercase ms-2 d-none",n.textContent="0",o.appendChild(n)),a||(a=document.createElement("i"),a.id=`chat-bell-${t}`,a.className="icon-base ti tabler-bell icon-16px text-warning ms-2 d-none",a.title="رسائل غير مقروءة",o.appendChild(a))}catch{}}function P(){const t=document.getElementById("chat-mute-toggle");if(!t)return;const e=!q(),n=t.querySelector("i"),a=t.querySelector(".label")||t;n&&(n.classList.toggle("bx-bell",!e),n.classList.toggle("bx-bell-off",e));const o=e?"تفعيل الإشعارات الصوتية":"كتم الإشعارات الصوتية";a===t?t.textContent=o:a.textContent=o,t.setAttribute("aria-pressed",e?"true":"false")}function A(){const t=document.getElementById("chat-mute-toggle");t&&(P(),t.addEventListener("click",()=>{const e=!q();G(e),P(),window.Swal&&window.Swal.fire?window.Swal.fire({toast:!0,position:"bottom-start",icon:"success",title:e?"تم تفعيل الإشعارات الصوتية":"تم كتم الإشعارات الصوتية",showConfirmButton:!1,timer:1800}):p(g.info,e?"تم تفعيل الإشعارات الصوتية":"تم كتم الإشعارات الصوتية")}))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A();function at(t){t&&Object.keys(t).forEach(e=>{const n=parseInt(t[e])||0,a=document.querySelector(`#chat-badge-${e}`),o=document.querySelector(`#chat-bell-${e}`);a&&(a.textContent=n,a.classList.toggle("d-none",n===0)),o&&o.classList.toggle("d-none",n===0)})}function N(){try{window.unreadCountsPoller&&clearInterval(window.unreadCountsPoller);const t=()=>{const e=window.currentConversationId?`?current=${encodeURIComponent(window.currentConversationId)}`:"";fetch(`${window.chatRoutes.unread}${e}`,{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"}).then(n=>n.status===404?(clearInterval(window.unreadCountsPoller),window.unreadCountsPoller=null,console.info("Unread counts endpoint not found; stopping poller."),null):n.ok?n.json():null).then(n=>{n&&at(n)}).catch(()=>{})};t(),window.unreadCountsPoller=setInterval(t,12e3)}catch{}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",N):N();function ot(t){var s;document.getElementById("sidebar-contact-name").textContent=t.name||"---",document.getElementById("sidebar-contact-role").textContent=t.role||"",document.getElementById("sidebar-contact-email").textContent=t.email||"",document.getElementById("sidebar-contact-about").textContent=t.about||"لا توجد تفاصيل...";const e=t.is_online?"متصل":"غير متصل",n=t.is_online?"#16c784":"#aaa";document.getElementById("sidebar-contact-status").textContent=e,document.getElementById("sidebar-contact-status").style.color=n;const a=(s=document.getElementById("active-chat-sidebar-avatar"))==null?void 0:s.querySelector("img");a&&(a.src=t.avatar||j(t.name),a.alt=t.name||"User");const o=document.getElementById("active-chat-avatar-wrapper");if(o){const r=o.querySelector("img");r&&(r.src=t.avatar||j(t.name),r.alt=t.name||"User",o.classList.remove("avatar-online","avatar-offline"),o.classList.add(t.is_online?"avatar-online":"avatar-offline"))}const u=document.getElementById("active-chat-status");u&&(u.textContent=e,u.style.color=n),window.currentChatUserId=t.id,k(t.id)}function j(t){return t=encodeURIComponent(t||"User"),`https://ui-avatars.com/api/?name=${t}&background=random&color=fff&size=128&rounded=true`}function I(t){var e;fetch(window.chatRoutes.user.replace(":id",t),{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"}).then(n=>n.json()).then(n=>{ot(n)}),(e=document.getElementById("app-chat-sidebar-right"))==null||e.classList.add("show")}function st(t){const e=document.getElementById("block-contact-btn"),n=document.getElementById("unblock-contact-btn"),a=document.getElementById("chat-message-input"),o=document.querySelector('#chat-message-form button[type="submit"]');console.log("Block buttons:",{blockBtn:e?"found":"not found",unblockBtn:n?"found":"not found"}),e&&n&&(t.i_blocked?(console.log("Setting to blocked state"),e.style.display="none",n.style.display="block",a&&(a.disabled=!0),o&&(o.disabled=!0)):t.blocked_me?(console.log("Setting to blocked by other state"),e.style.display="none",n.style.display="none",a&&(a.disabled=!0),o&&(o.disabled=!0)):(console.log("Setting to unblocked state"),e.style.display="block",n.style.display="none",a&&(a.disabled=!1),o&&(o.disabled=!1))),n&&n.addEventListener("click",function(u){u.preventDefault(),window.currentChatUserId&&it(window.currentChatUserId)})}function it(t){var e;t&&fetch(window.chatRoutes.unblock.replace(":id",t),{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","X-CSRF-TOKEN":(e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.content},credentials:"same-origin"}).then(n=>n.json()).then(()=>{k(t),p(g.success,"تم فك حظر المستخدم بنجاح",{title:"تم فك الحظر"})}).catch(n=>{console.error("Error unblocking user:",n),p(g.danger,"حدث خطأ أثناء فك الحظر",{title:"خطأ"})})}function k(t){t&&fetch(window.chatRoutes.blockStatus.replace(":id",t),{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json"},credentials:"same-origin"}).then(e=>e.json()).then(e=>{console.log("Block status response:",e),st(e)}).catch(e=>{console.error("Error checking block status:",e)})}function x(t){return t.avatar?ct(t.avatar):`https://ui-avatars.com/api/?name=${encodeURIComponent(t.name||"User")}&background=16c784&color=fff&size=128&rounded=true`}function ct(t){return t?t.startsWith("/")?window.location.origin+t:t:"/assets/img/avatars/default.png"}function E(t,e,n=null){var o,u;window.currentConversationId=t,(o=document.getElementById("app-chat-conversation"))==null||o.classList.add("d-none"),(u=document.getElementById("app-chat-history"))==null||u.classList.remove("d-none"),tt(t);try{const s=e&&e.type==="public",r=document.getElementById("block-contact-btn"),h=document.getElementById("unblock-contact-btn"),m=document.getElementById("report-contact"),l=document.getElementById("clear-chat");s?(r==null||r.classList.add("d-none"),h==null||h.classList.add("d-none"),m==null||m.classList.add("d-none"),l&&(z()?(l.classList.remove("d-none","disabled"),l.classList.remove("disabled"),l.removeAttribute("aria-disabled"),l.title=""):(l.classList.add("d-none"),l.classList.add("disabled"),l.setAttribute("aria-disabled","true"),l.title="مسح الدردشة العامة متاح للمشرف فقط"))):(r==null||r.classList.remove("d-none"),m==null||m.classList.remove("d-none"),l&&(l.classList.remove("d-none","disabled"),l.removeAttribute("aria-disabled"),l.title=""))}catch{}let a=e.type==="public"?e.title||"Public Chat":n?n.name:"Private Chat";if(document.getElementById("active-chat-name").textContent=a,window.currentChatUserId=n?n.id:null,e.type!=="public"&&window.currentChatUserId)fetch(window.chatRoutes.user.replace(":id",window.currentChatUserId),{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"}).then(s=>s.json()).then(s=>{const r=document.getElementById("active-chat-avatar");r&&(r.src=x(s),r.alt=s.name),document.getElementById("active-chat-name").textContent=s.name||a,document.getElementById("active-chat-status").textContent=s.is_online?"متصل":"غير متصل"});else{const s=document.getElementById("active-chat-avatar");s&&(s.src=(n==null?void 0:n.avatar)||"/assets/img/avatars/4.png",s.alt=a),document.getElementById("active-chat-status").textContent="غير متصل"}k(window.currentChatUserId),fetch(window.chatRoutes.messages.replace(":id",t),{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"}).then(s=>s.json()).then(s=>{D(s.messages||[]),s.messages&&s.messages.length?window.lastMessageId=s.messages[s.messages.length-1].id:window.lastMessageId=null,window.messagePoller&&clearInterval(window.messagePoller),window.messagePoller=setInterval(()=>{if(!window.currentConversationId)return;const r=window.chatRoutes.messages.replace(":id",window.currentConversationId)+(window.lastMessageId?`?after=${window.lastMessageId}`:"");fetch(r,{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"}).then(h=>h.json()).then(h=>{h.messages&&h.messages.length&&h.messages.forEach(m=>et(m,window.currentConversationId))}).catch(()=>{})},3e3)})}function D(t){const e=document.getElementById("chat-history-list");if(e){if(e.innerHTML="",!t.length){e.innerHTML='<li class="text-center my-4 text-muted">No messages yet</li>';return}t.forEach(n=>R(n)),W()}}function R(t){var l,b,y;const e=document.getElementById("chat-history-list");if(!e||document.querySelector(`#chat-history-list li[data-message-id='${t.id}']`))return;const n=t.sender||t.user||{},a=t.sender_id??t.user_id,o=String(a)===String((l=window.currentUser)==null?void 0:l.id),u=o?((b=window.currentUser)==null?void 0:b.avatar)||"/assets/img/avatars/4.png":n.avatar||"/assets/img/avatars/4.png",s=o?((y=window.currentUser)==null?void 0:y.name)||"Me":n.name||"User",r=a;let m=`
    <li class="chat-message ${o?"chat-message-right":""}" data-message-id="${t.id}">
      <div class="d-flex overflow-hidden align-items-center">
        ${o?"":`<div class="user-avatar flex-shrink-0 me-4">
                <div class="avatar avatar-sm" data-user-id="${r}" style="cursor:pointer;">
                  <img src="${u}" alt="Avatar" class="rounded-circle" />
                </div>
              </div>`}
        <div class="chat-message-wrapper flex-grow-1">
          <div class="chat-message-text">
            <p class="mb-0">${t.body}</p>
          </div>
          <div class="${o?"text-end":""} text-body-secondary mt-1">
            <small class="chat-username" data-user-id="${r}" style="cursor:pointer;">${s}</small>
          </div>
        </div>
        ${o?`<div class="user-avatar flex-shrink-0 ms-4">
                <div class="avatar avatar-sm" data-user-id="${r}" style="cursor:pointer;">
                  <img src="${u}" alt="Avatar" class="rounded-circle" />
                </div>
              </div>`:""}
      </div>
    </li>
  `;e.insertAdjacentHTML("beforeend",m),W(),t.id&&(window.lastMessageId=t.id)}function C(t=!1){var u;if(!((u=window.chatRoutes)!=null&&u.users)||window.contactsState.loading)return;window.contactsState.loading=!0;const{page:e,perPage:n,q:a}=window.contactsState,o=new URL(window.chatRoutes.users,window.location.origin);o.searchParams.set("page",e),o.searchParams.set("per_page",n),a&&a.trim()&&o.searchParams.set("q",a.trim()),window.contactsState.onlineOnly&&o.searchParams.set("online","1"),fetch(o.toString(),{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"}).then(s=>s.json()).then(s=>{let r=Array.isArray(s.users)?s.users:[];try{window.contactsState.onlineOnly&&(r=r.filter(m=>B(m)))}catch{}try{r=r.sort((m,l)=>{const b=B(m)?1:0,y=B(l)?1:0;if(y!==b)return y-b;const S=((m==null?void 0:m.name)||"").toLowerCase(),L=((l==null?void 0:l.name)||"").toLowerCase();return S.localeCompare(L,void 0,{sensitivity:"base"})})}catch{}const h=s.pagination||{};rt(r,t),window.contactsState.hasMore=!!h.has_more;try{const m=document.getElementById("contact-load-more");m&&m.classList.toggle("d-none",!window.contactsState.hasMore)}catch{}}).catch(()=>{}).finally(()=>{window.contactsState.loading=!1})}function rt(t,e=!1){var a,o;const n=document.getElementById("contact-list");if(n){if(e||n.querySelectorAll(".chat-contact-list-item:not(.chat-contact-list-item-title):not(.contact-list-item-0)").forEach(u=>u.remove()),!t.length&&!e){(a=document.querySelector(".contact-list-item-0"))==null||a.classList.remove("d-none");return}t.length&&((o=document.querySelector(".contact-list-item-0"))==null||o.classList.add("d-none")),t.forEach(u=>{let s=document.createElement("li");s.className="chat-contact-list-item",s.innerHTML=`
      <a href="#" class="d-flex align-items-center" data-user-id="${u.id}">
        <div class="flex-shrink-0 avatar ${B(u)?"avatar-online":"avatar-offline"}">
          <img src="${x(u)}" alt="${u.name}" class="rounded-circle" />
        </div>
        <div class="chat-contact-info flex-grow-1 ms-4">
          <h6 class="chat-contact-name text-truncate m-0 fw-normal">${u.name}</h6>
          <small class="chat-contact-status text-truncate">${u.email||""}</small>
        </div>
      </a>
    `,s.querySelector("a").addEventListener("click",function(r){r.preventDefault(),F(u.id,u.name)}),n.appendChild(s)})}}function H(){fetch(window.chatRoutes.conversations,{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"}).then(t=>t.json()).then(t=>dt(t.conversations||[]))}function dt(t){const e=document.getElementById("chat-list");if(e.querySelectorAll(".chat-contact-list-item:not(.chat-contact-list-item-title):not(.chat-list-item-0):not(#public-chat-li)").forEach(n=>n.remove()),!t.length){document.querySelector(".chat-list-item-0").classList.remove("d-none");return}document.querySelector(".chat-list-item-0").classList.add("d-none"),t.forEach(n=>{var m;let a=n.type==="private"&&n.users?n.users.find(l=>l.id!==window.currentUser.id):null,o=(m=n.users)==null?void 0:m.map(l=>l.name).join(", "),u=n.messages&&n.messages[0]?n.messages[0].body:"No messages yet",s=document.createElement("li");s.className="chat-contact-list-item mb-1";const r=n.unread_count||0;s.innerHTML=`
      <a href="#" class="d-flex align-items-center w-100" data-conversation-id="${n.id}">
        <div class="flex-shrink-0 avatar avatar-online">
          <img src="${x(a||{name:o})}" alt="Avatar" class="rounded-circle" />
        </div>
        <div class="chat-contact-info flex-grow-1 ms-4">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="chat-contact-name text-truncate m-0 fw-normal">${n.type==="public"?n.title||"Public Chat":o}</h6>
            <div class="d-flex align-items-center">
              <small class="chat-contact-list-item-time"></small>
              <span id="chat-badge-${n.id}" class="badge bg-danger ms-2 ${r?"":"d-none"}">${r||0}</span>
              <i id="chat-bell-${n.id}" class="icon-base ti tabler-bell icon-16px text-warning ms-2 ${r?"":"d-none"}" title="رسائل غير مقروءة"></i>
            </div>
          </div>
          <small class="chat-contact-status text-truncate">${u}</small>
        </div>
      </a>
    `,s.querySelector("a").addEventListener("click",function(l){l.preventDefault(),E(n.id,n,a)});try{if(n.type==="private"){const l=s.querySelector(".chat-contact-info"),b=document.createElement("button");b.type="button",b.className="btn btn-sm btn-icon btn-text-danger ms-2 chat-delete-btn",b.title="إخفاء المحادثة",b.innerHTML='<i class="ti tabler-trash"></i>',l==null||l.appendChild(b),b.addEventListener("click",function(y){y.stopPropagation(),y.preventDefault(),lt(n.id,s)})}}catch{}e.appendChild(s)})}function lt(t,e){if(!t)return;const n=()=>{var a;fetch(window.chatRoutes.hide.replace(":id",t),{method:"DELETE",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","X-CSRF-TOKEN":(a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.content},credentials:"same-origin"}).then(o=>o.json()).then(o=>{o&&o.success?(e&&e.parentNode&&e.parentNode.removeChild(e),p(g.success,"تم إخفاء المحادثة من قائمتك.",{title:"تم الإخفاء"})):p(g.danger,o&&o.message||"تعذر إخفاء المحادثة",{title:"خطأ"})}).catch(()=>{p(g.danger,"حدث خطأ أثناء الإخفاء",{title:"خطأ"})})};window.Swal&&window.Swal.fire?window.Swal.fire({title:"تأكيد الإخفاء",text:"سيتم إخفاء هذه المحادثة من قائمتك فقط ولن تُحذف الرسائل للطرف الآخر.",icon:"warning",showCancelButton:!0,confirmButtonText:"نعم، إخفاء",cancelButtonText:"إلغاء",customClass:{confirmButton:"btn btn-danger",cancelButton:"btn btn-outline-secondary ms-1"}}).then(a=>{a.isConfirmed&&n()}):confirm("سيتم إخفاء هذه المحادثة من قائمتك فقط. متابعة؟")&&n()}function F(t,e){var n;fetch(window.chatRoutes.createPrivate,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":(n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.content},body:JSON.stringify({user_id:t})}).then(a=>a.json()).then(a=>{a.conversation_id&&E(a.conversation_id,{id:a.conversation_id,users:[{id:t,name:e}]},{id:t,name:e})})}document.addEventListener("DOMContentLoaded",function(){var h,m,l,b,y,S,L,T,_,M;window.chatRoutes&&window.chatRoutes.conversations&&H(),window.chatRoutes&&window.chatRoutes.users&&C();try{const c=document.querySelector("#app-chat-contacts .chat-search-input")||document.querySelector(".chat-search-input");if(c){const d=nt(()=>{const i=c.value||"";window.contactsState.q=i,window.contactsState.page=1,window.contactsState.hasMore=!0,C(!1)},350);c.addEventListener("input",d)}}catch{}try{const c=document.getElementById("contacts-online-only");c&&c.addEventListener("change",()=>{window.contactsState.onlineOnly=!!c.checked,window.contactsState.page=1,window.contactsState.hasMore=!0,C(!1)})}catch{}try{const c=document.querySelector("#app-chat-contacts .sidebar-body");c&&c.addEventListener("scroll",()=>{c.scrollTop+c.clientHeight>=c.scrollHeight-200&&window.contactsState.hasMore&&!window.contactsState.loading&&(window.contactsState.page+=1,C(!0))})}catch{}try{const c=document.getElementById("contact-load-more-btn");c&&c.addEventListener("click",()=>{window.contactsState.hasMore&&!window.contactsState.loading&&(window.contactsState.page+=1,C(!0))})}catch{}const t=document.getElementById("public-chat-li");t&&((h=window.chatRoutes)!=null&&h.public)&&t.addEventListener("click",async function(c){c.preventDefault();try{let d=window.PUBLIC_CHAT_ID,i="الدردشة العامة";if(!d){const w=await(await fetch(window.chatRoutes.public,{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"})).json();w!=null&&w.id&&(d=w.id,i=w.title||i,window.PUBLIC_CHAT_ID=d,t.dataset.conversationId=d,X(d))}d&&E(d,{id:d,type:"public",title:i},null)}catch{}});const e=window.PUBLIC_CHAT_ID||((m=t==null?void 0:t.dataset)==null?void 0:m.conversationId);e&&X(e),(l=document.getElementById("chat-message-form"))==null||l.addEventListener("submit",function(c){var i;c.preventDefault();const d=document.getElementById("chat-message-input");!d.value.trim()||!window.currentConversationId||fetch(window.chatRoutes.sendMessage.replace(":id",window.currentConversationId),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":(i=document.querySelector('meta[name="csrf-token"]'))==null?void 0:i.content},credentials:"same-origin",body:JSON.stringify({body:d.value.trim(),type:"text"})}).then(async f=>{if(!f.ok){let v={};try{v=await f.json()}catch{}console.error("Error response:",v),p("failure",v.message||"غير مسموح بإرسال الرسائل.");return}const w=await f.json();w.message&&(R(w.message),d.value="")})}),(b=document.getElementById("chat-history-list"))==null||b.addEventListener("click",function(c){var i;let d=c.target;if(d.closest(".avatar-sm")||d.classList.contains("chat-username")){let f=(i=d.closest("[data-user-id]"))==null?void 0:i.getAttribute("data-user-id");f&&I(f)}}),(y=document.getElementById("active-chat-avatar"))==null||y.addEventListener("click",function(){window.currentChatUserId&&I(window.currentChatUserId)}),(S=document.getElementById("active-chat-name"))==null||S.addEventListener("click",function(){window.currentChatUserId&&I(window.currentChatUserId)});function n(){if(!window.currentConversationId)return;const c=()=>{var d;fetch(window.chatRoutes.clear.replace(":id",window.currentConversationId),{method:"DELETE",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","X-CSRF-TOKEN":(d=document.querySelector('meta[name="csrf-token"]'))==null?void 0:d.content},credentials:"same-origin"}).then(i=>i.json()).then(i=>{i.success?(document.getElementById("chat-history-list").innerHTML='<li class="text-center text-muted p-3">لا توجد رسائل</li>',p(g.success,"تم مسح المحادثة بنجاح",{title:"تم المسح"})):p(g.danger,i.message||"حدث خطأ أثناء المسح",{title:"خطأ"})}).catch(()=>{p(g.danger,"حدث خطأ أثناء المسح",{title:"خطأ"})})};window.Swal&&typeof window.Swal.fire=="function"?window.Swal.fire({title:"تأكيد المسح",text:"هل أنت متأكد من مسح جميع رسائل هذه المحادثة؟",icon:"warning",showCancelButton:!0,confirmButtonText:"نعم",cancelButtonText:"إلغاء",customClass:{confirmButton:"btn btn-danger",cancelButton:"btn btn-outline-secondary ms-1"}}).then(d=>{d.isConfirmed&&c()}):confirm("هل أنت متأكد من مسح جميع رسائل هذه المحادثة؟")&&c()}function a({i_blocked:c,blocked_me:d}){const i=document.getElementById("block-contact-btn"),f=document.getElementById("unblock-contact-btn"),w=document.getElementById("chat-message-input"),v=document.querySelector('#chat-message-form button[type="submit"]');c?(i==null||i.classList.add("d-none"),f==null||f.classList.remove("d-none"),w&&(w.disabled=!0),v&&(v.disabled=!0)):d?(i==null||i.classList.add("d-none"),f==null||f.classList.add("d-none"),w&&(w.disabled=!0),v&&(v.disabled=!0)):(i==null||i.classList.remove("d-none"),f==null||f.classList.add("d-none"),w&&(w.disabled=!1),v&&(v.disabled=!1))}function o(c){c&&fetch(window.chatRoutes.blockStatus.replace(":id",c),{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json"},credentials:"same-origin"}).then(d=>d.json()).then(a).catch(()=>{})}function u(c){var d;c&&fetch(window.chatRoutes.block.replace(":id",c),{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","X-CSRF-TOKEN":(d=document.querySelector('meta[name="csrf-token"]'))==null?void 0:d.content},credentials:"same-origin"}).then(i=>i.json()).then(()=>{o(c),p(g.success,"تم حظر المستخدم بنجاح",{title:"تم الحظر"})}).catch(i=>{console.error("Error blocking user:",i),p(g.danger,"حدث خطأ أثناء حظر المستخدم",{title:"خطأ"})})}function s(c){var d;c&&fetch(window.chatRoutes.unblock.replace(":id",c),{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","X-CSRF-TOKEN":(d=document.querySelector('meta[name="csrf-token"]'))==null?void 0:d.content},credentials:"same-origin"}).then(i=>i.json()).then(()=>{o(c),p(g.success,"تم فك حظر المستخدم بنجاح",{title:"تم فك الحظر"})}).catch(i=>{console.error("Error unblocking user:",i),p(g.danger,"حدث خطأ أثناء فك الحظر",{title:"خطأ"})})}function r(){if(!window.currentChatUserId)return;const c=()=>{if(window.Swal&&typeof window.Swal.fire=="function")window.Swal.fire({title:"الإبلاغ عن المستخدم",input:"textarea",inputPlaceholder:"سبب الإبلاغ...",showCancelButton:!0,confirmButtonText:"إرسال",cancelButtonText:"إلغاء",inputAttributes:{dir:"auto"},customClass:{confirmButton:"btn btn-primary",cancelButton:"btn btn-outline-secondary ms-1"},preConfirm:i=>((!i||!i.trim())&&window.Swal.showValidationMessage("يرجى كتابة سبب الإبلاغ"),i)}).then(i=>{i.isConfirmed&&i.value&&d(i.value.trim())});else{const i=prompt("يرجى كتابة سبب الإبلاغ:");i&&i.trim()&&d(i.trim())}},d=i=>{var f;fetch(`/dashboard/chat/report/${window.currentChatUserId}`,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","X-CSRF-TOKEN":(f=document.querySelector('meta[name="csrf-token"]'))==null?void 0:f.content},body:JSON.stringify({reason:i})}).then(w=>w.json()).then(w=>{w.success?p(g.success,"تم الإبلاغ بنجاح",{title:"تم الإبلاغ"}):p(g.danger,w.message||"حدث خطأ أثناء الإبلاغ",{title:"خطأ"})}).catch(()=>{p(g.danger,"حدث خطأ أثناء الإبلاغ",{title:"خطأ"})})};c()}(L=document.getElementById("clear-chat"))==null||L.addEventListener("click",n),(T=document.getElementById("block-contact-btn"))==null||T.addEventListener("click",function(){u(window.currentChatUserId)}),(_=document.getElementById("unblock-contact-btn"))==null||_.addEventListener("click",function(){s(window.currentChatUserId)}),(M=document.getElementById("report-contact"))==null||M.addEventListener("click",r),window.showContactSidebar=I,window.openConversation=E,window.renderMessages=D,window.createPrivateChat=F,window.loadContacts=C,window.loadConversations=H,window.appendMessageToChat=R});
