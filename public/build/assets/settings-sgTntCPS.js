document.getElementById("settingsForm");document.querySelector('input[name="site_logo"]');document.querySelector('img[src*="site_logo"]');document.querySelector('input[name="site_favicon"]');document.querySelector('img[src*="site_favicon"]');function u(e){try{return btoa(unescape(encodeURIComponent(e)))}catch{return btoa(e)}}const f="google_ads_",m=e=>e&&e.indexOf(f)===0;function p(e){const n=[];for(const[t]of e.entries())n.includes(t)||n.push(t);return n.forEach(t=>{if(!m(t))return;const s=e.get(t);if(typeof s!="string")return;const r=s.trim();if(!r||r.startsWith("__B64__"))return;const o=u(r);e.set(t,`__B64__${o}`)}),e}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".settings-form").forEach(t=>{y(t)}),typeof jQuery<"u"&&typeof $.fn.select2<"u"&&$(".select2").select2(),typeof $.fn.colorpicker<"u"&&$(".colorpicker").each(function(){$(this).colorpicker({format:"hex"}).on("colorpickerChange",function(t){$(this).closest(".input-group").find(".color-preview").css("background-color",t.color.toString())})}),document.querySelectorAll('input[type="file"]').forEach(t=>{const s=t.parentElement.querySelector("img");s&&g(t,s)}),S(),h()});function g(e,n){!e||!n||e.addEventListener("change",function(){if(this.files&&this.files[0]){const t=new FileReader;t.onload=function(s){n.src=s.target.result,n.style.display="block"},t.readAsDataURL(this.files[0])}})}function y(e){e.addEventListener("submit",async function(n){n.preventDefault();const t=e.querySelector('button[type="submit"]');t&&(t.disabled=!0,t.innerHTML='<i class="spinner-border spinner-border-sm me-1"></i> Saving...');try{const s=new FormData(e);p(s);const r=await fetch(e.getAttribute("action"),{method:"POST",body:s,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"},credentials:"same-origin"});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const o=await r.json();if(o.success)l(o.message||"Settings updated successfully"),o.reload&&setTimeout(()=>window.location.reload(),1e3);else throw new Error(o.message||"Failed to update settings")}catch(s){console.error("Settings update error:",s),c(s.message||"An error occurred while saving settings")}finally{t&&(t.disabled=!1,t.innerHTML="Save Changes")}})}function S(){const e=document.querySelector("#test-smtp-btn");e&&e.addEventListener("click",async function(n){n.preventDefault(),e.disabled=!0,e.innerHTML='<i class="spinner-border spinner-border-sm me-1"></i> Testing...';try{const t=await fetch(e.dataset.url,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"},credentials:"same-origin"});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const s=await t.json();if(s.success)l(s.message);else throw new Error(s.message||"SMTP test failed")}catch(t){console.error("SMTP test error:",t),c(t.message||"Failed to test SMTP connection")}finally{e.disabled=!1,e.innerHTML="Test SMTP Connection"}})}function h(){const e=document.querySelector("#testEmailModal");if(!e)return;const n=e.querySelector("#send-test-email-btn"),t=e.querySelector("#test_email"),s=e.dataset.url;if(!n||!t||!s){console.error("Required elements for test email not found");return}n.addEventListener("click",async function(r){r.preventDefault();const o=t.value.trim();if(!o){c("Please enter a test email address");return}n.disabled=!0,n.innerHTML='<i class="spinner-border spinner-border-sm me-1"></i> Sending...';try{const i=await fetch(s,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({test_email:o}),credentials:"same-origin"});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const a=await i.json();if(a.success){l(a.message);const d=bootstrap.Modal.getInstance(e);d&&d.hide(),t.value=""}else throw new Error(a.message||"Failed to send test email")}catch(i){console.error("Test email error:",i),c(i.message||"Failed to send test email")}finally{n.disabled=!1,n.innerHTML="Send Test Email"}})}function l(e){typeof Swal<"u"?Swal.fire({title:"Success!",text:e,icon:"success",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):alert(e)}function c(e){typeof Swal<"u"?Swal.fire({title:"Error!",text:e,icon:"error",customClass:{confirmButton:"btn btn-danger"},buttonsStyling:!1}):alert(e)}
